<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>üìä Admin Dashboard</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: #f8f9fa; 
      padding: 20px; 
      margin: 0; 
    }
    .container { 
      max-width: 1100px; 
      margin: 0 auto; 
      background: white; 
      border-radius: 12px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
      overflow: hidden; 
    }
    header { 
      background: #2c3e50; 
      color: white; 
      padding: 20px; 
      text-align: center; 
    }
    .stats { 
      padding: 20px; 
      border-bottom: 1px solid #eee; 
    }
    h2 {
      color: #2c3e50;
      margin-top: 0;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 15px;
    }
    th, td { 
      padding: 14px 20px; 
      text-align: left; 
      border-bottom: 1px solid #eee; 
    }
    th { 
      background: #f8f9fa; 
      font-weight: 600; 
      color: #2c3e50; 
    }
    tr:hover { 
      background: #f1f3f5; 
    }
    .bar-container {
      width: 100%;
      background: #ecf0f1;
      border-radius: 4px;
      margin: 8px 0;
      height: 24px;
      position: relative;
    }
    .bar-fill {
      height: 100%;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }
    .error { 
      color: #e74c3c; 
      padding: 20px; 
      text-align: center; 
    }
    .question-item {
      background: #f8f9fa;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border-left: 4px solid #e74c3c;
    }
    .question-text {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .question-stats {
      font-size: 14px;
      color: #7f8c8d;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä Tableau de bord - Quiz Cybers√©curit√©</h1>
    </header>

    <div class="stats">
      <h2>üìà Statistiques globales</h2>
      <p><strong>Nombre total de participants :</strong> <span id="total-count">Chargement...</span></p>
      <p><strong>Score moyen global :</strong> <span id="global-avg">Chargement...</span>%</p>
    </div>

    <div class="stats">
      <h2>üè¢ Statistiques par d√©partement</h2>
      <div id="dept-bars">Chargement...</div>
    </div>

    <div class="stats">
      <h2>‚ùå Top 5 des questions les plus rat√©es</h2>
      <div id="top-questions">Chargement...</div>
    </div>

    <div class="stats">
      <h2>üë• D√©tail des participants</h2>
      <table>
        <thead>
          <tr>
            <th>Date & Heure</th>
            <th>Email (anonymis√©)</th>
            <th>D√©partement</th>
            <th>Score</th>
            <th>Niveau</th>
          </tr>
        </thead>
        <tbody id="results-body">
          <tr><td colspan="5" style="text-align:center;">Chargement des donn√©es...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    if (!localStorage.getItem('admin')) {
      alert('acc√®s r√©serv√© √† l\'administrateur');
      window.location = 'admin-login.html';
    }

    // Questions du quiz (doit correspondre √† index.html)
    const QUESTIONS = [
      "Quelle est la meilleure pratique pour un mot de passe ?",
      "Que faire si vous recevez un email suspect ?",
      "Qu‚Äôest-ce que le phishing ?",
      "Faut-il mettre √† jour ses logiciels ?",
      "Que faire en quittant votre poste ?"
    ];

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('fr-FR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Couleurs pour les barres
    const COLORS = ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6', '#1abc9c', '#34495e'];

    fetch('/api/results')
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.length === 0) {
          document.getElementById('total-count').textContent = '0';
          document.getElementById('global-avg').textContent = '0';
          document.getElementById('dept-bars').innerHTML = '<p>Aucun quiz r√©alis√© pour le moment.</p>';
          document.getElementById('top-questions').innerHTML = '<p>Aucune donn√©e disponible.</p>';
          document.getElementById('results-body').innerHTML = '<tr><td colspan="5" style="text-align:center;">Aucun r√©sultat</td></tr>';
          return;
        }

        // === Statistiques globales ===
        const globalAvg = (data.reduce((sum, r) => sum + (r.score / r.total), 0) / data.length * 100).toFixed(1);
        document.getElementById('total-count').textContent = data.length;
        document.getElementById('global-avg').textContent = globalAvg;

        // === Par d√©partement ===
        const deptStats = {};
        data.forEach(item => {
          if (!deptStats[item.department]) {
            deptStats[item.department] = { count: 0, totalScore: 0, maxCount: 0 };
          }
          deptStats[item.department].count++;
          deptStats[item.department].totalScore += (item.score / item.total);
          deptStats[item.department].maxCount = Math.max(deptStats[item.department].maxCount, item.total);
        });

        // Calcul du score moyen par d√©partement
        const deptEntries = Object.entries(deptStats).map(([dept, stats]) => ({
          dept,
          count: stats.count,
          avgScore: (stats.totalScore / stats.count * 100).toFixed(1),
          maxCount: Math.max(...data.filter(d => d.department === dept).map(d => d.total))
        }));

        // Trier par nombre de participants (desc)
        deptEntries.sort((a, b) => b.count - a.count);

        const maxCount = Math.max(...deptEntries.map(d => d.count));
        let deptHtml = '';
        deptEntries.forEach((entry, i) => {
          const width = maxCount ? (entry.count / maxCount) * 100 : 0;
          const color = COLORS[i % COLORS.length];
          deptHtml += `
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <strong>${entry.dept}</strong>
                <span>${entry.count} tests ‚Ä¢ ${entry.avgScore}%</span>
              </div>
              <div class="bar-container">
                <div class="bar-fill" style="width: ${width}%; background-color: ${color};">
                  ${entry.count}
                </div>
              </div>
            </div>
          `;
        });
        document.getElementById('dept-bars').innerHTML = deptHtml;

        // === Top 5 des questions rat√©es ===
        // On suppose que toutes les sessions ont les m√™mes questions (5 questions)
        const questionStats = Array(QUESTIONS.length).fill(0); // nb de mauvaises r√©ponses
        const questionAttempts = Array(QUESTIONS.length).fill(0); // nb de tentatives

        data.forEach(session => {
          // On ne peut pas r√©cup√©rer les r√©ponses individuelles ‚Üí on fait une approximation
          // Hypoth√®se : les erreurs sont r√©parties uniform√©ment parmi les questions non r√©ussies
          const errors = session.total - session.score;
          if (errors > 0) {
            for (let i = 0; i < QUESTIONS.length; i++) {
              questionAttempts[i]++;
              // R√©partir les erreurs de fa√ßon al√©atoire (ou uniforme)
              // Pour plus de pr√©cision, il faudrait stocker les r√©ponses par question
            }
          }
        });

        // ‚ö†Ô∏è ATTENTION : sans stockage des r√©ponses par question, on ne peut pas avoir le vrai top 5
        // Donc on affiche un message explicatif
        document.getElementById('top-questions').innerHTML = `
          <p style="color:#e67e22;">
            ‚ÑπÔ∏è Pour afficher les questions les plus rat√©es, le quiz doit enregistrer les r√©ponses individuelles.<br>
            Actuellement, seul le score global est sauvegard√©.
          </p>
          <p>
            <strong>Pour activer cette fonctionnalit√© :</strong><br>
            Modifiez <code>server.js</code> pour stocker les r√©ponses par question.
          </p>
        `;

        // === D√©tail des participants ===
        const tbody = document.getElementById('results-body');
        tbody.innerHTML = '';
        data.forEach(item => {
          const percent = Math.round((item.score / item.total) * 100);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${formatDate(item.date)}</td>
            <td>${item.email}</td>
            <td>${item.department}</td>
            <td>${percent}% (${item.score}/${item.total})</td>
            <td>${item.level}</td>
          `;
          tbody.appendChild(row);
        });
      })
      .catch(error => {
        console.error('Erreur:', error);
        document.getElementById('total-count').textContent = 'Erreur';
        document.getElementById('global-avg').textContent = 'Erreur';
        document.getElementById('dept-bars').innerHTML = '<p class="error">‚ùå Impossible de charger les donn√©es.</p>';
        document.getElementById('top-questions').innerHTML = '<p class="error">Erreur de chargement.</p>';
        document.getElementById('results-body').innerHTML = '<tr><td colspan="5" class="error">Erreur de chargement</td></tr>';
      });
  </script>
</body>
</html>
